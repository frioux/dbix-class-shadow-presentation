<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
        "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
   <title>DBIx::Class::Shadow</title>

   <!-- configuration parameters -->
   <meta name="defaultView" content="slideshow" />
   <meta name="controlVis" content="hidden" />

  <!-- configuration transition extension -->
   <meta name="tranSitions" content="true" />
   <meta name="fadeDuration" content="500" />
   <meta name="incrDuration" content="250" />

   <!-- configuration autoplay extension -->
   <meta name="autoMatic" content="false" />
   <meta name="playLoop" content="true" />
   <meta name="playDelay" content="10" />

   <!-- configuration audio extension -->
   <meta name="audioSupport" content="false" />
   <meta name="audioVolume" content="0" />
   <meta name="audioError" content="false" />

   <!-- configuration audio debug -->
   <meta name="audioDebug" content="false" />

   <!-- style sheet links -->
   <link rel="stylesheet" href="ui/scala_utf/slides.css" type="text/css" media="projection" id="slideProj" />
   <link rel="stylesheet" href="ui/scala_utf/outline.css" type="text/css" media="screen" id="outlineStyle" />
   <link rel="stylesheet" href="ui/scala_utf/print.css" type="text/css" media="print" id="slidePrint" />
   <link rel="stylesheet" href="ui/scala_utf/opera.css" type="text/css" media="projection" id="operaFix" />

   <!-- embedded styles -->
   <style type="text/css" media="all">
      .imgcon {
         width: 100%;
         margin: 0 auto;
         padding: 0;
         text-align: center;
      }
      #anim {
         width: 33%;
         height: 320px;
         position: relative;
      }
      #anim img {
         position: absolute;
         top: 0px;
         left: 0px;
      }
      .red {color: red;}
      .grey {color: gray;}
   </style>

   <!-- S5 JS -->
   <script src="ui/scala_utf/slides.js" type="text/javascript"></script>
</head>
<body>

<div class="layout">
   <div id="controls"><!-- DO NOT EDIT --></div>
   <div id="currentSlide"><!-- DO NOT EDIT --></div>
   <div id="header"></div>
   <div id="footer">
      <h1>DBIx::Class::Shadow</h1>
      <h2>YAPC::NA 2011</h2>
   </div>
</div>

<div class="presentation">

   <div class="slide">
      <h1>DBIx::Class::Shadow</h1>
      <h4>Peter Rabbitson (ribasushi)</h4>
      <h4>Arthur Axel "fRIOUX" Schmidt</h4>
   </div>

   <div class="slide">
      <h1>What is DBIx::Class::Shadow?</h1>
      <ul class="incremental">
         <li>Database Auditing tool</li>
         <li>Flexible</li>
         <li>CRAZY SQL</li>
      </ul>
   </div>

   <div class="slide">
      <h1>Can't I just use DBIx::Class::Journal?</h1>
      <ul class="incremental">
         <li>Can only version single PK tables (no join tables)</li>
         <li>Uses separate schema and connection (good and bad)</li>
         <li>All or none (columns)</li>
         <li>Everything must be in a transaction</li>
         <li>Awkward to set up</li>
         <li>Not very helpful API for real usage</li>
         <li>Update/Delete cascades not supported</li>
      </ul>
   </div>

   <div class="slide">
      <h1>Can't I just use Database Triggers?</h1>
      <ul class="incremental">
         <li>Not cross DB</li>
         <li>Not nearly as powerful</li>
         <li>But soon you can (soon?) anyway</li>
      </ul>
   </div>

   <div class="slide">
      <h1>Can't I log business level transactions?</h1>
      <ul class="incremental">
         <li>Short sighted</li>
         <li>Lots of work</li>
         <li>You'll probably do it wrong</li>
         <li>Create your own API :/</li>
      </ul>
   </div>

   <div class="slide">
      <h1>Terminology</h1>
      <ul class="incremental">
         <li>Shadow - a specific version for a given row object</li>
         <li>Changeset - a transaction of changes optionally tied to a user (or anything else)</li>
         <li>Shadow Stage - insert | update | delete</li>
         <li>Shadow Lifecycle - persistent across inserts, updates, and deletes</li>
      </ul>
   </div>

   <div class="slide">
      <h1>Setup (schema)</h1>
<pre>
package MyApp::Schema;

use warnings;
use strict;

use parent 'DBIx::Class::Schema';
__PACKAGE__-&gt;load_components(qw/Schema::Shadow/);

__PACKAGE__-&gt;shadow_result_base_class( 'DBICTest::S::BaseShadowResult' );
__PACKAGE__-&gt;shadow_changeset_result( 'DBIC::ShadowTest::Result::Changeset' );

__PACKAGE__-&gt;load_namespaces;

1;
</pre>
   </div>

   <div class="slide">
      <h1>Setup (result)</h1>
<pre>
package MyApp::Schema::Result::Artist;

use warnings;
use strict;

use base 'MyApp::Schema::Result';
# defaults to all columns
__PACKAGE__-&gt;load_components('Shadow');
__PACKAGE__-&gt;shadow_columns([qw(id name)]);

__PACKAGE__-&gt;table('artists');

__PACKAGE__-&gt;add_columns(
  id =&gt; { data_type =&gt; 'int' },
  name =&gt; { data_type =&gt; 'varchar', size =&gt; 30 },
  notes =&gt; { data_type =&gt; 'text' },
);

__PACKAGE__-&gt;set_primary_key('id');

__PACKAGE__-&gt;has_many(cds =&gt; 'MyApp::Schema::Result::CD', 'artist_id');

1;
</pre>
   </div>

   <div class="slide">
      <h1>Changeset Usage</h1>
<pre>
$schema-&gt;changeset_do({ system =&gt; undef, user_id =&gt; 5, session_id =&gt; 76 }, sub {
   ...
})
</pre>
   </div>

   <div class="slide">
      <h1>Shadow ResultSet methods</h1>
      <ul class="incremental">
         <li>version</li>
         <li>before</li>
         <li>after</li>
         <li>changeset</li>
         <li>groknik</li>
      </ul>
   </div>

   <div class="slide">
      <h1>Shadow ResultSet methods (version)</h1>
   </div>

   <div class="slide">
      <h1>Shadow ResultSet methods (before)</h1>
<pre>
$rs-&gt;before(
   version =&gt; 5,
);

$rs-&gt;before(
   datetime =&gt; $dt,
);

$rs-&gt;before(
   changeset =&gt; 5,
);

$rs-&gt;before(
   changeset_datetime =&gt; $dt,
);
</pre>
   </div>

   <div class="slide">
      <h1>Shadow ResultSet methods (after)</h1>
   </div>

   <div class="slide">
      <h1>Shadow ResultSet methods (changeset)</h1>
   </div>

   <div class="slide">
      <h1>Shadow ResultSet methods (groknik)</h1>
   </div>


   <div class="slide">
      <h1>Changeset: See the schema at a given state</h1>
   </div>

   <div class="slide">
      <h1>Applications</h1>
      <ul class="incremental">
         <li>Database Changelog For Debugging</li>
         <li>Database Changelog For Users (See JIRA)</li>
         <li>Reverting Changes</li>
      </ul>
   </div>

   <div class="slide">
      <h1>Questions?</h1>
   </div>

   <div class="slide">
      <h1>THE END</h1>
   </div>

</div>
</body>
</html>
